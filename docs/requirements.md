# M5ポモドーロタイマー 要件仕様

## 1. 背景と目的
- M5Stack Basic をポモドーロタイマーとして活用し、作業時間を可視化・記録する。
- 待機状態と開始ボタンで作業 25 分・休憩 5 分のワークロードを交互に進め、利用者が送信ボタンを押したタイミングで Notion の特定データベースへ累積経過時間を記録する。
- 作業内容のタグ付けは Notion 側で手動管理し、M5Stack 側は時間計測と送信に特化する。
- Notion へ記録する経過時間は休憩を含む合計時間を以下の法則で丸める：
  - 15分刻みで0.25時間ずつ増やす（1-15分→0.25時間、16-30分→0.5時間、31-45分→0.75時間、46-60分→1.0時間、61-75分→1.25時間...）

## 2. ステークホルダー
- 利用者（個人の作業者）
- M5Stack デバイス
- Notion ワークスペース（データベース管理者）

## 3. 想定構成
- ハードウェア: M5Stack Basic（本体ボタン、内蔵スピーカ、LCD 表示）
- ソフトウェア:
  - M5Stack 向けファームウェア（本リポジトリで開発）
  - Notion API（[Insert Database Item](https://developers.notion.com/reference/post-page) を利用）
- 接続: M5Stack Basic から Wi-Fi 経由で Notion 公開 API へ HTTPS リクエスト

## 4. 基本用語
- **作業フェーズ**: 待機状態から開始される作業時間。デフォルト 25 分。
- **休憩フェーズ**: 作業後に実施する休息時間。デフォルト 5 分。
- **待機状態**: 作業フェーズ・休憩フェーズのいずれでもない状態。開始ボタン入力を待つ。
- **トータル経過時間**: リセット以降、作業・休憩・一時停止を含めて積算した時間。
- **ログ**: 送信ボタン長押し時点のトータル経過時間と付随情報をまとめた Notion への記録。

## 5. 機能要件
### 5.1 タイマー機能
- F1: タイマーは「待機」「作業」「休憩」「一時停止」の状態を持つ。待機状態で開始ボタン（A）を長押し（200ms）すると現在のターン（初期値は作業）を起動し、所定の時間（作業 25 分／休憩 5 分）をカウントダウンする。終了後は自動的に待機状態へ戻り、次回開始時は作業と休憩が待機状態を挟んで交互に切り替わる。
- F1-1: すべてのボタン操作は長押し（200ms）で実行される。ボタンを長押しすると、長押し検知時に短い1音（800Hz、50ms）が鳴る。
- F2: 作業中または休憩中に開始ボタン（A）を長押し（200ms）すると一時停止に遷移し、同ボタン再長押しで残り時間から再開する。一時停止中は残り時間およびトータル経過時間を進めない。
- F3: LCD には現在の状態・残り時間に加えて、リセット（送信完了または電源投入）からのトータル経過時間（休憩を含む）を常時表示する。
- F4: 作業時間・休憩時間が終了すると短い2音（1000Hz、150ms × 2回、間隔100ms）のブザーと画面表示で完了を通知し、タイマーは待機状態に戻る。通知後は一時停止を経由せず次のターン開始待ちとなる。
- F5: 送信ボタン（C）を長押し（200ms）すると、その時点までのトータル経過時間と付帯情報のスナップショットを生成し、Notion への POST を即座に実行する。タイマー状態・累積値・次に開始するターン（作業）を初期化した待機状態に即時遷移する。

### 5.2 Notion 連携
- F6: 送信ボタン（C）長押し時に Notion への POST を実行する。POST の実行状況（送信中・成功・失敗）をステータス表示に反映する。
- F6-1: Wi-Fi 接続状態であれば、そのまま POST を実行する。
- F6-2: Wi-Fi 未接続状態であれば、POST 情報をキューとしてストックする。
- F6-3: POST が成功した場合、ステータスに「Notion updated」を表示する。
- F6-4: POST が失敗した場合、ステータスに「POST失敗」を表示し、かつ情報をキューとしてストックする。
- F6-5: キューにストックされた情報は、Wi-Fi に接続されたタイミングで自動的に POST する。キューは FIFO（先入先出）で処理される。
- F6-6: POST 実行時、必ずサーバー（NTP）から現時刻を取得して Date を補正する。これにより、デバイスの時刻がずれていても正確な日時で記録される。
- F7: ログには下記プロパティを含める。日時はすべて日本標準時（Asia/Tokyo）で計算・整形する。
  - Date（Date プロパティ）: 作業開始日時の暦日。POST 時にサーバーから取得した現時刻を基準に補正した値を `YYYY/MM/DD` 形式で設定する。
  - H（Number プロパティ）: トータル経過時間（休憩を含む合計時間）を時間単位に換算し、15分刻みで0.25時間ずつ増やす法則で丸めた値（1-15分→0.25時間、16-30分→0.5時間、31-45分→0.75時間、46-60分→1.0時間、61-75分→1.25時間...）
  - Notes（Title プロパティ）: 作業開始時刻の時分を `HH:MM AM/PM` 形式（12時間制）で記録する。POST 時にサーバーから取得した現時刻を基準に補正した値を使用する。
  - Cat（Select プロパティ）: 固定値 `DeskWork` を設定する。
  - ddd（Text プロパティ）: 作業開始日時の曜日 ID を `1_Mon` ～ `7_Sun` の形式で保存する。POST 時にサーバーから取得した現時刻を基準に補正した値を使用する。
  - fromM5（Checkbox プロパティ）: M5Stack デバイスからの送信であることを示すフラグ。常に `true` を設定する。
- F8: ネットワーク未接続時は送信リクエストをキューに保持し、オンライン復帰後に順次送信する。送信完了までログデータを保持し、成功後にキューから削除する。キューは不揮発性メモリ（Preferences/NVS）に保存され、再起動後も保持される。これにより、電源断や再起動が発生しても未送信データが失われることはない。
- F9: Notion のタグ付けは本システムでは扱わないため、タグ用のプロパティは作成しない。
- F10: 起動直後に Wi-Fi 接続と NTP による時刻同期を行い、初回開始ボタン長押し時刻を基準に Date・Notes・ddd を算出する。
- F10-1: Wi-Fi 接続はバックグラウンドで実行され、起動後はすぐに待機モードに移行する。接続待機による起動遅延は発生しない。
- F10-2: `secrets.h` に記載されている Wi-Fi 情報から接続可能なネットワークを順次探し続ける。接続に失敗した場合は次の Wi-Fi 設定を試行し、すべての設定を試行した後は最初の設定に戻って繰り返す。
- F10-3: Wi-Fi 接続に成功した場合、接続できた SSID をステータス表示に反映し、Wi-Fi 接続状態の表示を緑色にする。接続中は黄色、未接続時はグレーで表示する。

### 5.3 設定と状態管理
- F11: Wi-Fi SSID / パスワード、Notion インテグレーショントークン、データベース ID は Git に含めないローカル専用ファイル（`secrets.h`）に記載し、`.gitignore` で除外したうえで起動時に読み込む。Wi-Fi 設定は複数候補（最大10個）を配列で保持し、接続可能なものを順次選択する。配布物には `secrets.h` のテンプレートを `docs/secrets_h_guide.md` に記載し、利用者が複製して値を記入する。M5 デバイス上での入力・保存機能は提供しない。
- F12: デバイスは起動時にユニークなセッション ID を生成し、送信ボタン長押しでログをスナップショット保存した直後に新しいセッション ID を初期化する。セッション ID は電源断からの復旧やキュー管理のためにデバイス内で保持し、Notion へは送信しない。
- F13: ブザーは常に有効であり、ミュート機能は提供しない。作業フェーズ・休憩フェーズの開始時には短い1音（1200Hz、120ms）が鳴り、終了時には短い2音（1000Hz、150ms × 2回、間隔100ms）が鳴る。

## 6. 非機能要件
- N1: タイマーの時間誤差は ±1 秒以内。
- N2: ネットワーク処理中でも表示やボタン応答がフリーズしない（非同期処理 or 非ブロッキング設計）。
- N3: 不具合や通信失敗を画面上で分かりやすく通知する。
- N4: API トークン等の機密情報は平文で表示しない。
- N5: ファームウェアは OTA アップデート対応を検討（任意）。

## 7. Notion データモデル
- 対象データベース例:
  - `Date` (Date プロパティ, 作業開始日時の暦日を JST で保持)
  - `H` (Number プロパティ, 休憩を含むトータル経過時間を時間単位で丸めた値。15分刻みで0.25時間ずつ増やす法則で丸める（1-15分→0.25、16-30分→0.5、31-45分→0.75、46-60分→1.0、61-75分→1.25...）)
  - `Notes` (Title プロパティ, 作業開始時刻 `HH:MM AM/PM` 形式（12時間制）)
  - `Cat` (Select プロパティ, 固定値 `DeskWork`)
  - `ddd` (Text プロパティ, 曜日 ID `1_Mon` ～ `7_Sun`)
  - `fromM5` (Checkbox プロパティ, M5Stack デバイスからの送信を示すフラグ。常に `true`)
- 通信仕様:
  - 認証: Internal Integration トークンによる Bearer 認証。
  - リクエストヘッダ: `Content-Type: application/json`, `Notion-Version: 2022-06-28`（最新推奨バージョンを利用）。
  - API エンドポイント: `https://api.notion.com/v1/pages`。

## 8. UI/UX 仕様
### 8.1 待機状態
待機画面はアクティブ画面と同じレイアウト構造で構成される：

#### 8.1.1 プログレスバー
- 画面上部にプログレスバーが表示される。
- バーは横幅100%（画面幅いっぱい）で固定表示される。
- 待機状態ではグレー色で表示される。
- バーの高さは80px、Y位置は20px（アクティブ画面と同じ）。

#### 8.1.2 バーの中の表示（重ねて表示）
バーの中にStateと次のフェーズを重ねて表示する：
- **左寄せ**: 「Waiting / Next: [Phase]」形式で表示（例：「Waiting / Next: Work」「Waiting / Next: Break」）。バーの色を背景色として使用し、バーの上部（Y位置+15px）に配置される。
- **右寄せ**: 待機中は残り時間を表示しない。

#### 8.1.3 バーの下の表示
- トータル経過時間（「Total: HH:MM:SS」形式）
- 丸め込み値（「Rounded: X.XXh」形式）

#### 8.1.4 詳細情報（小さく表示）
バーの下の情報のさらに下に、以下の情報を小さなテキスト（テキストサイズ1）で表示：
- **ボタンアサイン**:
  - A: Start
  - C: Send & Reset
- **Wi-Fi 接続状態**:
  - 接続成功時: 「Wi-Fi: [SSID]」（緑色）
  - 接続中: 「Wi-Fi: Connecting...」（黄色）
  - 未接続時: 「Wi-Fi: Offline」（グレー）
- **キュー状態**: 「Queue: X / 10」形式で現在のキュー数と最大保存数を表示。キューのたまり具合に応じて色が変わる：
  - 0個: グレー（空）
  - 1-3個: 緑色（少ない）
  - 4-7個: 黄色（中程度）
  - 8-10個: 赤色（多い、ほぼ満杯）
- **電池残量**: 「Battery: XX%」形式で表示。残量に応じて色が変わる：
  - 50%超: 緑色
  - 20%超50%以下: 黄色
  - 20%以下: 赤色
- **POST 状況表示**: 送信ボタン（C）長押し時、POST の実行状況をステータス表示に反映する。
  - 送信中: 「Queued log for Notion」を表示（黄色）
  - 成功: 「Notion updated」を表示（黄色）
  - 失敗: 「POST失敗」を表示（黄色）

### 8.2 作業フェーズ・休憩フェーズ（アクティブ画面）
アクティブ画面は以下のレイアウトで構成される：

#### 8.2.1 プログレスバー
- フェーズが開始されると、画面上部にプログレスバーが表示される。
- バーは開始時に横幅100%（画面幅いっぱい）から始まり、残り時間とともに幅が小さくなる（残り時間が減るにつれてバーの幅も減る）。
- 作業フェーズでは赤系の色、休憩フェーズでは青系の色で表示される。
- バーの高さは80px、Y位置は20px（上に余白を確保）。

#### 8.2.2 バーの中の表示（重ねて表示）
バーの中にStateとフェーズ、残り時間を重ねて表示する：
- **左寄せ**: タイマーの状態（Running/Paused）と現在のフェーズ（Work/Break）を「State / Phase」形式で表示（例：「Running / Work」「Paused / Work」「Running / Break」）。実行中は「Running」、一時停止時は「Paused」と表示し、一時停止時はテキスト色を黄色にする。バーの色を背景色として使用し、バーの上部（Y位置+15px）に配置される。
- **右寄せ**: 残り時間を大きく表示（テキストサイズ4）。右端から10pxの位置に右寄せで表示される。バーの下部（Y位置+45px）に配置される。テキストがバーの範囲内にある場合はバーの色を背景色に、範囲外の場合は黒を背景色に使用する。

#### 8.2.3 バーの下の表示
- トータル経過時間（「Total: HH:MM:SS」形式）
- 丸め込み値（「Rounded: X.XXh」形式）

#### 8.2.4 詳細情報（小さく表示）
バーの下の情報のさらに下に、以下の情報を小さなテキスト（テキストサイズ1）で表示：
- **ボタンアサイン**:
  - A: Pause（実行中の場合）または A: Resume（一時停止中の場合）
  - C: Send & Reset
- **Wi-Fi 接続状態**:
  - 接続成功時: 「Wi-Fi: [SSID]」（緑色）
  - 接続中: 「Wi-Fi: Connecting...」（黄色）
  - 未接続時: 「Wi-Fi: Offline」（グレー）
- **キュー状態**: 「Queue: X / 10」形式で現在のキュー数と最大保存数を表示。キューのたまり具合に応じて色が変わる：
  - 0個: グレー（空）
  - 1-3個: 緑色（少ない）
  - 4-7個: 黄色（中程度）
  - 8-10個: 赤色（多い、ほぼ満杯）
- **電池残量**: 「Battery: XX%」形式で表示。残量に応じて色が変わる：
  - 50%超: 緑色
  - 20%超50%以下: 黄色
  - 20%以下: 赤色
- **POST 状況表示**: 送信ボタン（C）長押し時、POST の実行状況をステータス表示に反映する。
  - 送信中: 「Queued log for Notion」を表示（黄色）
  - 成功: 「Notion updated」を表示（黄色）
  - 失敗: 「POST失敗」を表示（黄色）

### 8.3 共通仕様
- ボタン操作: すべてのボタン（A、C）は長押し（200ms）で実行される。長押し検知時に短い1音（800Hz、50ms）が鳴る。
- 通知: 作業時間・休憩時間の終了時に短い2音（1000Hz、150ms × 2回、間隔100ms）のブザーと画面表示で完了を通知する。
- エラー表示: 通信失敗時にエラーメッセージと再試行ステータスを画面下部に表示する。

## 9. 運用・保守
- ログ再送: 再送キューは FIFO で動作し、不揮発性メモリ（Preferences/NVS）に保存される。再起動後もキューが保持されるため、未送信のログは失われることはない。Wi-Fi 接続が復旧すると自動的に送信が再開される。
- セキュリティ: トークンやパスワードは USB 経由のシリアルコンソールでも直接表示しない。
- 制限事項:
  - キューは不揮発性メモリに保存されるが、Preferences の容量制限（約4000バイト）により、保存可能なキューアイテム数には上限がある。最大保存数は10個で、UI上に「X / 10」形式で表示される。
  - タイマー状態やトータル経過時間は再起動時にリセットされる
  - 統計情報（作業フェーズ完了回数、当日累積作業時間など）は保持されない

