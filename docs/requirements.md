# M5ポモドーロタイマー 要件仕様

## 1. 背景と目的
- M5Stack Basic をポモドーロタイマーとして活用し、作業時間を可視化・記録する。
- 1 サイクル（集中時間＋休憩）が完了するごとに Notion の特定データベースへ記録し、作業ログを蓄積する。
- 作業内容のタグ付けは Notion 側で手動管理し、M5Stack 側は時間計測と送信に特化する。

## 2. ステークホルダー
- 利用者（個人の作業者）
- M5Stack デバイス
- Notion ワークスペース（データベース管理者）

## 3. 想定構成
- ハードウェア: M5Stack Basic（本体ボタン、内蔵スピーカ、LCD 表示）
- ソフトウェア:
  - M5Stack 向けファームウェア（本リポジトリで開発）
  - Notion API（[Insert Database Item](https://developers.notion.com/reference/post-page) を利用）
- 接続: M5Stack Basic から Wi-Fi 経由で Notion 公開 API へ HTTPS リクエスト

## 4. 基本用語
- **集中フェーズ**: ポモドーロの作業時間。デフォルト 25 分。
- **休憩フェーズ**: 作業後の休息時間。デフォルト 5 分。
- **サイクル完了**: 集中フェーズとその直後の休憩フェーズが終わったタイミング。
- **ログ**: Notion データベースに保存される 1 サイクル分の記録。

## 5. 機能要件
### 5.1 タイマー機能
- F1: ポモドーロ（集中・休憩）サイクルを自動で進行し、残り時間を LCD に表示する。
- F2: ボタン操作（A/B/C）で `開始/一時停止`、`スキップ`、`キャンセル（作業ログ送信）` を割り当てる。
- F3: 起動時にデフォルト値（集中 25 分、休憩 5 分）を読み込み、値はファームウェアで固定する（M5 デバイス上での設定変更は行わない）。
- F4: サイクル完了時にサウンド／画面点滅で通知する。

### 5.2 Notion 連携
- F5: 集中フェーズが完了した直後、または集中フェーズ中にキャンセルされたタイミングで Notion API へ HTTPS でログを送信する。
- F6: ログ内容には以下のプロパティを含める:
  - 開始日時（集中フェーズ開始時刻）
  - 終了日時（集中フェーズ完了時刻またはキャンセル時刻）
  - 集中時間（実測値、分単位）
  - セッション ID（M5 起動時に生成されたユニーク ID）
  - セッション内サイクル番号（1 から増分する連番）
- F7: ネットワーク未接続時はログをローカル（RTC メモリ or SPIFFS）にキューし、オンライン復帰後に再送する。
- F8: Notion のタグ付けは本システムでは扱わないため、タグ用のプロパティは作成しない。
- F9: 起動直後に Wi-Fi 接続と NTP による時刻同期を行い、時刻が取得できた後で集中フェーズ開始時刻・終了時刻を記録する。

### 5.3 設定と状態管理
- F9: Wi-Fi SSID / パスワード、Notion インテグレーショントークン、データベース ID は Git に含めないローカル専用ファイル（例: `config/local_credentials.json`）に記載し、`.gitignore` で除外したうえで起動時に読み込む。Wi-Fi 設定は複数の候補を配列で保持し、接続可能なものを順次選択する。配布物には `config/local_credentials.sample.json` を同梱し、利用者が複製して値を記入する。M5 デバイス上での入力・保存機能は提供しない。
- F12: デバイスは起動時にユニークなセッション ID を生成し、電源再投入まで維持する。各集中サイクルにはセッション ID とセッション内サイクル番号を紐付け、Notion へ送信する。別作業を開始する場合はデバイスを再起動し、新しいセッション ID とサイクル番号に切り替える。
- F10: サイクル統計（当日サイクル数、累計集中時間）を M5Stack 側で保持し、必要に応じて画面に表示する。
- F11: デバイスは再起動後も前回の設定・統計情報を復元する。

## 6. 非機能要件
- N1: タイマーの時間誤差は ±1 秒以内。
- N2: ネットワーク処理中でも表示やボタン応答がフリーズしない（非同期処理 or 非ブロッキング設計）。
- N3: 不具合や通信失敗を画面上で分かりやすく通知する。
- N4: API トークン等の機密情報は平文で表示しない。
- N5: ファームウェアは OTA アップデート対応を検討（任意）。

## 7. Notion データモデル
- 対象データベース例:
  - `Start Date` (Date プロパティ, 開始時刻)
  - `End Date` (Date プロパティ, 記録対象の終了時刻)
  - `Work Duration (min)` (Number プロパティ)
  - `Session ID` (Text プロパティ)
  - `Cycle In Session` (Number プロパティ)
  - `Memo` (Rich text; 任意)
- 通信仕様:
  - 認証: Internal Integration トークンによる Bearer 認証。
  - リクエストヘッダ: `Content-Type: application/json`, `Notion-Version: 2022-06-28`（最新推奨バージョンを利用）。
  - API エンドポイント: `https://api.notion.com/v1/pages`。

## 8. UI/UX 仕様（案）
- 集中フェーズ: 残り時間・サイクル番号・当日総時間を表示。視覚的に集中中であることを示す配色。
- 休憩フェーズ: 残り時間と次の集中開始予定時刻を表示。
- 通知: サイクル完了時に効果音、画面背景色変更。
- エラー表示: 通信失敗時にエラーメッセージと再試行ステータスを画面下部に表示。

## 9. 運用・保守
- ログ再送: 再送キューは FIFO、最大保持件数を設定（例: 50 サイクル）。上限超過時は古いログを削除し、ユーザーへ通知。
- 設定バックアップ: 定期的に設定値を SD カードへエクスポートするオプション（任意）。
- セキュリティ: トークンやパスワードは USB 経由のシリアルコンソールでも直接表示しない。

## 10. 今後の拡張アイデア
- タグ候補を Notion から取得し、M5Stack 側で選択できるよう拡張。
- Slack 等への通知連携。
- 作業カテゴリ別の統計ダッシュボード自動生成（Notion 側での自動化と連動）。

