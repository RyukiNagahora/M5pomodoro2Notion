# M5ポモドーロタイマー 要件仕様

## 1. 背景と目的
- M5Stack Basic をポモドーロタイマーとして活用し、作業時間を可視化・記録する。
- 待機状態と開始ボタンで作業 25 分・休憩 5 分のワークロードを交互に進め、利用者が送信ボタンを押したタイミングで Notion の特定データベースへ累積経過時間を記録する。
- 作業内容のタグ付けは Notion 側で手動管理し、M5Stack 側は時間計測と送信に特化する。
- Notion へ記録する経過時間は休憩を含む合計時間を 0.25 時間刻みで丸める。

## 2. ステークホルダー
- 利用者（個人の作業者）
- M5Stack デバイス
- Notion ワークスペース（データベース管理者）

## 3. 想定構成
- ハードウェア: M5Stack Basic（本体ボタン、内蔵スピーカ、LCD 表示）
- ソフトウェア:
  - M5Stack 向けファームウェア（本リポジトリで開発）
  - Notion API（[Insert Database Item](https://developers.notion.com/reference/post-page) を利用）
- 接続: M5Stack Basic から Wi-Fi 経由で Notion 公開 API へ HTTPS リクエスト

## 4. 基本用語
- **作業フェーズ**: 待機状態から開始される作業時間。デフォルト 25 分。
- **休憩フェーズ**: 作業後に実施する休息時間。デフォルト 5 分。
- **待機状態**: 作業フェーズ・休憩フェーズのいずれでもない状態。開始ボタン入力を待つ。
- **トータル経過時間**: リセット以降、作業・休憩・一時停止を含めて積算した時間。
- **ログ**: 送信ボタン押下時点のトータル経過時間と付随情報をまとめた Notion への記録。

## 5. 機能要件
### 5.1 タイマー機能
- F1: タイマーは「待機」「作業」「休憩」「一時停止」の状態を持つ。待機状態で開始ボタン（A）を押すと現在のターン（初期値は作業）を起動し、所定の時間（作業 25 分／休憩 5 分）をカウントダウンする。終了後は自動的に待機状態へ戻り、次回開始時は作業と休憩が待機状態を挟んで交互に切り替わる。
- F2: 作業中または休憩中に開始ボタン（A）を押すと一時停止に遷移し、同ボタン再押下で残り時間から再開する。一時停止中は残り時間およびトータル経過時間を進めない。
- F3: LCD には現在の状態・残り時間に加えて、リセット（送信完了または電源投入）からのトータル経過時間（休憩を含む）を常時表示する。
- F4: 作業時間・休憩時間が終了するとブザーと画面表示で完了を通知し、タイマーは待機状態に戻る。通知後は一時停止を経由せず次のターン開始待ちとなる。
- F5: 送信ボタン（C）を押すと、その時点までのトータル経過時間と付帯情報のスナップショットを生成して Notion 送信キューへ登録し、タイマー状態・累積値・次に開始するターン（作業）を初期化した待機状態に即時遷移する。

### 5.2 Notion 連携
- F6: 送信キューに登録されたログを Notion API へ HTTPS で送信する。送信処理中は進行状況を画面に表示し、完了・失敗の結果を待機状態から確認できるようにする。
- F7: ログには下記プロパティを含める。日時はすべて日本標準時（Asia/Tokyo）で計算・整形する。
  - Date（Date プロパティ）: 作業開始日時の暦日。`YYYY/MM/DD` 形式で設定する。
  - H（Number プロパティ）: トータル経過時間（休憩を含む合計時間）を時間単位に換算し、0.25 刻み四捨五入した値。
  - Notes（Title プロパティ）: 作業開始時刻の時分を `HH:MM` 形式で記録する。
  - Cat（Select プロパティ）: 固定値 `DeskWork` を設定する。
  - ddd（Text プロパティ）: 作業開始日時の曜日 ID を `1_Mon` ～ `7_Sun` の形式で保存する。
- F8: ネットワーク未接続時は送信リクエストをローカル（RTC メモリ or SPIFFS）にキューし、オンライン復帰後に順次送信する。送信完了までログデータを保持し、成功後にキューから削除する。
- F9: Notion のタグ付けは本システムでは扱わないため、タグ用のプロパティは作成しない。
- F10: 起動直後に Wi-Fi 接続と NTP による時刻同期を行い、初回開始ボタン押下時刻を基準に Date・Notes・ddd を算出する。

### 5.3 設定と状態管理
- F11: Wi-Fi SSID / パスワード、Notion インテグレーショントークン、データベース ID は Git に含めないローカル専用ファイル（例: `config/local_credentials.json`）に記載し、`.gitignore` で除外したうえで起動時に読み込む。Wi-Fi 設定は複数候補を配列で保持し、接続可能なものを順次選択する。配布物には `config/local_credentials.sample.json` を同梱し、利用者が複製して値を記入する。M5 デバイス上での入力・保存機能は提供しない。
- F12: デバイスは起動時にユニークなセッション ID を生成し、送信ボタン押下でログをスナップショット保存した直後に新しいセッション ID とセッション内カウンタ（作業フェーズ数など）を初期化する。セッション ID は電源断からの復旧やキュー管理のためにデバイス内で保持し、Notion へは送信しない。
- F13: 作業フェーズ完了回数、当日累積作業時間、トータル経過時間などの統計を M5Stack 側で保持し、必要に応じて画面に表示する。送信ボタン押下後はセッション関連の統計をリセットしつつ、日次集計は継続できるようにする。
- F14: デバイスは再起動後も未送信のタイマー状態および設定情報を復元し、誤操作や電源断でもトータル経過時間を失わないようにする。

## 6. 非機能要件
- N1: タイマーの時間誤差は ±1 秒以内。
- N2: ネットワーク処理中でも表示やボタン応答がフリーズしない（非同期処理 or 非ブロッキング設計）。
- N3: 不具合や通信失敗を画面上で分かりやすく通知する。
- N4: API トークン等の機密情報は平文で表示しない。
- N5: ファームウェアは OTA アップデート対応を検討（任意）。

## 7. Notion データモデル
- 対象データベース例:
  - `Date` (Date プロパティ, 作業開始日時の暦日を JST で保持)
  - `H` (Number プロパティ, 休憩を含むトータル経過時間を時間単位 0.25 刻みで四捨五入)
  - `Notes` (Title プロパティ, 作業開始時刻 `HH:MM`)
  - `Cat` (Select プロパティ, 固定値 `DeskWork`)
  - `ddd` (Text プロパティ, 曜日 ID `1_Mon` ～ `7_Sun`)
- 通信仕様:
  - 認証: Internal Integration トークンによる Bearer 認証。
  - リクエストヘッダ: `Content-Type: application/json`, `Notion-Version: 2022-06-28`（最新推奨バージョンを利用）。
  - API エンドポイント: `https://api.notion.com/v1/pages`。

## 8. UI/UX 仕様（案）
- 待機状態: 次に開始するターン（作業／休憩）とトータル経過時間、ボタン案内（開始・送信）を表示。
- 作業フェーズ: 残り時間・トータル経過時間・完了済み作業フェーズ数を表示し、作業中であることを示す配色にする。
- 休憩フェーズ: 残り時間・トータル経過時間・再開予定時刻を表示し、休憩中であることを示す配色にする。
- 通知: 作業時間・休憩時間の終了時に効果音と画面背景色変更で完了を通知する。
- エラー表示: 通信失敗時にエラーメッセージと再試行ステータスを画面下部に表示する。

## 9. 運用・保守
- ログ再送: 再送キューは FIFO、最大保持件数を設定（例: 50 エントリ）。上限超過時は古いログを削除し、ユーザーへ通知。
- 設定バックアップ: 定期的に設定値を SD カードへエクスポートするオプション（任意）。
- セキュリティ: トークンやパスワードは USB 経由のシリアルコンソールでも直接表示しない。

## 10. 今後の拡張アイデア
- タグ候補を Notion から取得し、M5Stack 側で選択できるよう拡張。
- Slack 等への通知連携。
- 作業カテゴリ別の統計ダッシュボード自動生成（Notion 側での自動化と連動）。

