# M5ポモドーロタイマー 要件仕様

## 1. 背景と目的
- M5Stack Basic をポモドーロタイマーとして活用し、作業時間を可視化・記録する。
- 1 サイクル（集中時間＋休憩）が完了するごとに Notion の特定データベースへ記録し、作業ログを蓄積する。
- 作業内容のタグ付けは Notion 側で手動管理し、M5Stack 側は時間計測と送信に特化する。

## 2. ステークホルダー
- 利用者（個人の作業者）
- M5Stack デバイス
- Notion ワークスペース（データベース管理者）

## 3. 想定構成
- ハードウェア: M5Stack Basic（本体ボタン、内蔵スピーカ、LCD 表示）
- ソフトウェア:
  - M5Stack 向けファームウェア（本リポジトリで開発）
  - Notion API（[Insert Database Item](https://developers.notion.com/reference/post-page) を利用）
- 接続: M5Stack Basic から Wi-Fi 経由で Notion 公開 API へ HTTPS リクエスト

## 4. 基本用語
- **集中フェーズ**: ポモドーロの作業時間。デフォルト 25 分。
- **休憩フェーズ**: 作業後の休息時間。デフォルト 5 分。4 サイクルごとに長めの休憩（例: 15 分）を設定するオプションを持つ。
- **サイクル完了**: 集中フェーズとその直後の休憩フェーズが終わったタイミング。
- **ログ**: Notion データベースに保存される 1 サイクル分の記録。

## 5. 機能要件
### 5.1 タイマー機能
- F1: ポモドーロ（集中・休憩）サイクルを自動で進行し、残り時間を LCD に表示する。
- F2: ボタン操作（A/B/C）で `開始/一時停止`、`スキップ`、`設定モード遷移` を割り当てる。
- F3: 起動時にデフォルト値（集中 25 分、休憩 5 分、長休憩 15 分、長休憩間隔 4 サイクル）を読み込み、設定変更後は Flash に保存する。
- F4: サイクル完了時にサウンド／画面点滅で通知する。

### 5.2 Notion 連携
- F5: サイクル完了直後に Notion API へ HTTPS でログを送信する。
- F6: ログ内容には以下のプロパティを含める:
  - 日時（集中開始時刻またはサイクル完了時刻）
  - 集中時間（分）
  - 休憩時間（分）
  - サイクル種別（通常／長休憩）
  - 備考フィールド（任意メモ、エラー時の再送識別子など）
- F7: ネットワーク未接続時はログをローカル（RTC メモリ or SPIFFS）にキューし、オンライン復帰後に再送する。
- F8: Notion のタグ付けは利用者が後から行うため、タグフィールドは空欄で送信する。

### 5.3 設定と状態管理
- F9: Wi-Fi SSID / パスワード、Notion インテグレーショントークン、データベース ID を設定モードから入力・保存できる。
- F10: サイクル統計（当日サイクル数、累計集中時間）を M5Stack 側で保持し、必要に応じて画面に表示する。
- F11: デバイスは再起動後も前回の設定・統計情報を復元する。

## 6. 非機能要件
- N1: タイマーの時間誤差は ±1 秒以内。
- N2: ネットワーク処理中でも表示やボタン応答がフリーズしない（非同期処理 or 非ブロッキング設計）。
- N3: 不具合や通信失敗を画面上で分かりやすく通知する。
- N4: API トークン等の機密情報は平文で表示しない。
- N5: ファームウェアは OTA アップデート対応を検討（任意）。

## 7. Notion データモデル
- 対象データベース例:
  - `Date` (Date プロパティ, サイクル完了日時)
  - `Duration (min)` (Number プロパティ)
  - `Break (min)` (Number プロパティ)
  - `Cycle Type` (Select プロパティ: `Focus`, `Long Break`)
  - `Source` (Select or Text; 固定値 `M5Stack`)
  - `Memo` (Rich text; 任意)
  - `Tags` (Multi-select; 利用者が Notion で手動設定)
- 通信仕様:
  - 認証: Internal Integration トークンによる Bearer 認証。
  - リクエストヘッダ: `Content-Type: application/json`, `Notion-Version: 2022-06-28`（最新推奨バージョンを利用）。
  - API エンドポイント: `https://api.notion.com/v1/pages`。

## 8. UI/UX 仕様（案）
- 集中フェーズ: 残り時間・サイクル番号・当日総時間を表示。視覚的に集中中であることを示す配色。
- 休憩フェーズ: 残り時間と次の集中開始予定時刻を表示。
- 通知: サイクル完了時に効果音、画面背景色変更。長休憩は別の色。
- エラー表示: 通信失敗時にエラーメッセージと再試行ステータスを画面下部に表示。

## 9. 運用・保守
- ログ再送: 再送キューは FIFO、最大保持件数を設定（例: 50 サイクル）。上限超過時は古いログを削除し、ユーザーへ通知。
- 設定バックアップ: 定期的に設定値を SD カードへエクスポートするオプション（任意）。
- セキュリティ: トークンやパスワードは USB 経由のシリアルコンソールでも直接表示しない。

## 10. 今後の拡張アイデア
- タグ候補を Notion から取得し、M5Stack 側で選択できるよう拡張。
- Slack 等への通知連携。
- 作業カテゴリ別の統計ダッシュボード自動生成（Notion 側での自動化と連動）。
